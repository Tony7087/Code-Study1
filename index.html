<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stock Investment Simulator V3.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #ffffff;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            min-height: 100vh;
            min-height: 100dvh;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
            color: #ffeb00;
        }

        .subtitle {
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #87CEEB;
        }

        .version-badge {
            text-align: center;
            margin-bottom: 30px;
        }

        .badge {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .input-group {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 250px;
            max-width: 350px;
        }

        .input-field label {
            font-size: 1.1em;
            color: #FFD700;
            font-weight: bold;
        }

        .input-field input {
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            width: 100%;
            font-weight: bold;
            -webkit-appearance: none;
            appearance: none;
        }

        .input-field input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 35px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
        }

        #startBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #startBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        #startBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #resetBtn,
        #downloadLogBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        #resetBtn:hover,
        #downloadLogBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .error-alert {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            border: 2px solid #ff0000;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            animation: shake 0.5s;
        }

        .error-alert.show {
            display: block;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        .error-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .error-message {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .monitoring-panel {
            background: rgba(0, 0, 0, 0.4);
            border-left: 5px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .monitoring-panel.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .monitoring-panel.error {
            border-left-color: #ff4444;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .monitoring-title {
            font-size: 1.5em;
            color: #00ff00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .monitoring-title.error {
            color: #ff4444;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-indicator.running {
            background: #00ff00;
        }

        .status-indicator.completed {
            background: #4169E1;
            animation: none;
        }

        .status-indicator.error {
            background: #ff4444;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .monitoring-content {
            font-size: 1.1em;
            line-height: 1.8;
            color: #E0E0E0;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #FFD700;
            border-bottom: 3px solid #FFD700;
            padding-bottom: 10px;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .indicator-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .indicator-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .indicator-card h4 {
            color: #FFD700;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .indicator-value {
            font-size: 1.3em;
            font-weight: bold;
            margin: 8px 0;
        }

        .indicator-signal {
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 5px;
        }

        .signal-positive {
            background: #00ff00;
            color: #000;
        }

        .signal-negative {
            background: #ff4444;
            color: #fff;
        }

        .signal-neutral {
            background: #ffa500;
            color: #000;
        }

        .score-board {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .score-board h3 {
            font-size: 2em;
            color: #1a1a1a;
            margin-bottom: 15px;
        }

        .total-score {
            font-size: 4em;
            font-weight: bold;
            color: #1a1a1a;
            margin: 20px 0;
        }

        .grade {
            font-size: 2em;
            color: #1a1a1a;
            font-weight: bold;
            margin-top: 10px;
        }

        .market-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .market-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .market-card h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .market-card .value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .market-card .change {
            font-size: 1.2em;
        }

        .positive {
            color: #00ff00;
        }

        .negative {
            color: #ff4444;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 10px;
        }

        .stock-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            text-align: left;
            font-size: 1.1em;
            color: #FFD700;
        }

        .stock-table td {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.05em;
        }

        .stock-table tr:hover td {
            background: rgba(255, 255, 255, 0.1);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .result-summary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .result-summary h3 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 1.2em;
        }

        .result-item strong {
            color: #1a1a1a;
        }

        .result-item .value {
            font-weight: bold;
            color: #1a1a1a;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff00;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .detail-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .detail-score-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 0.95em;
        }

        .detail-score-item .name {
            color: #87CEEB;
        }

        .detail-score-item .score {
            color: #FFD700;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸš€ í•œêµ­ ì£¼ì‹ ì‹œì¥ ìë™ ë§¤ë§¤ ì‹œë®¬ë ˆì´ì…˜ V3.5</h1>
        <p class="subtitle">15ê°€ì§€ ê¸€ë¡œë²Œ ì§€í‘œ ê¸°ë°˜ AI íˆ¬ì ë¶„ì„ ì‹œìŠ¤í…œ</p>
        <div class="version-badge">
            <span class="badge">âœ¨ V3.5 - Bug Fixed</span>
        </div>

        <!-- Error Alert -->
        <div id="errorAlert" class="error-alert">
            <div class="error-title">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="control-panel">
            <div class="input-group">
                <div class="input-field">
                    <label for="initialCapital">ğŸ’° ì´ˆê¸° íˆ¬ìê¸ˆ (ì›)</label>
                    <input type="text" id="initialCapital" value="1,000,000">
                    <div id="capitalKorean" style="font-size: 0.9em; color: #87CEEB; margin-top: 5px;"></div>
                </div>
                <div class="input-field">
                    <label for="targetReturn">ğŸ“ˆ ëª©í‘œ ìˆ˜ìµë¥  (%)</label>
                    <input type="number" id="targetReturn" value="5" min="1" max="50" step="1">
                </div>
            </div>
            <div class="button-container">
                <button id="startBtn">â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
                <button id="resetBtn">ğŸ”„ ì´ˆê¸°í™”</button>
                <button id="downloadLogBtn">ğŸ“¥ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>

        <!-- Agent Monitoring Panel -->
        <div id="monitoringPanel" class="monitoring-panel">
            <div class="monitoring-title" id="monitoringTitleContainer">
                <span class="status-indicator running"></span>
                <span id="monitoringTitle">Agent Monitoring</span>
            </div>
            <div class="monitoring-content" id="monitoringContent">
                ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
            </div>
        </div>

        <!-- Global Indicators Section -->
        <div id="indicatorsSection" class="section hidden">
            <h2 class="section-title">ğŸŒ ê¸€ë¡œë²Œ ì‹œì¥ ì§€í‘œ ë¶„ì„ (15ê°œ ì§€í‘œ)</h2>
            <div class="indicators-grid" id="indicatorsGrid"></div>
        </div>

        <!-- Composite Score Section -->
        <div id="scoreSection" class="section hidden">
            <h2 class="section-title">ğŸ“Š ì¢…í•© íˆ¬ì ì ìˆ˜</h2>
            <div class="score-board" id="scoreBoard"></div>
            <div class="detail-scores" id="detailScores"></div>
        </div>

        <!-- Market Summary Section -->
        <div id="marketSection" class="section hidden">
            <h2 class="section-title">ğŸ“Š í•œêµ­ ì‹œì¥ ìš”ì•½</h2>
            <div class="market-summary" id="marketSummary"></div>
        </div>

        <!-- Rising Stocks Section -->
        <div id="risingSection" class="section hidden">
            <h2 class="section-title">ğŸ“ˆ AI ì„ ì • ê¸‰ë“± ì¢…ëª© (ì ìˆ˜ ê¸°ë°˜ í•„í„°ë§)</h2>
            <table class="stock-table" id="risingStocksTable">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ì¢…ëª©ëª…</th>
                        <th>ì¢…ëª©ì½”ë“œ</th>
                        <th>AI ì ìˆ˜</th>
                        <th>ì‹œê°€</th>
                        <th>í˜„ì¬ê°€</th>
                        <th>ìƒìŠ¹ë¥ </th>
                        <th>ê±°ë˜ëŸ‰</th>
                    </tr>
                </thead>
                <tbody id="risingStocksBody"></tbody>
            </table>
        </div>

        <!-- Trading Simulation Section -->
        <div id="tradingSection" class="section hidden">
            <h2 class="section-title">ğŸ’° ê°€ìƒ ë§¤ë§¤ ì‹¤í–‰</h2>
            <div id="tradingInfo"></div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- Final Results Section -->
        <div id="resultsSection" class="section hidden">
            <h2 class="section-title">ğŸ“Š 3ì‹œê°„ ìˆ˜ìµë¥  ê²°ì‚° (12:00)</h2>
            <div class="result-summary" id="resultSummary"></div>
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // ==================== ì „ì—­ ì—ëŸ¬ í•¸ë“¤ë§ (Safari í˜¸í™˜ì„±) ====================
        window.onerror = function (msg, url, line, col, error) {
            const errorMsg = 'Error: ' + msg + '\nLine: ' + line + ':' + col;
            if (typeof logger !== 'undefined') {
                logger.error('Global Error', errorMsg);
            }
            return false;
        };

        // Promise rejection í•¸ë“¤ë§
        window.addEventListener('unhandledrejection', function (event) {
            if (typeof logger !== 'undefined') {
                logger.error('Unhandled Promise Rejection', event.reason);
            }
        });

        // ==================== ë¡œê·¸ ì‹œìŠ¤í…œ ====================
        class LogSystem {
            constructor() {
                this.logs = [];
                this.startTime = new Date();
            }

            log(level, message, data = null) {
                const timestamp = new Date();
                const elapsed = ((timestamp - this.startTime) / 1000).toFixed(2);

                const logEntry = {
                    timestamp: timestamp.toISOString(),
                    elapsed: `${elapsed}s`,
                    level: level,
                    message: message,
                    data: data
                };

                this.logs.push(logEntry);

                // Consoleì—ë„ ì¶œë ¥ (Safari í˜¸í™˜)
                const consoleMsg = '[' + elapsed + 's] [' + level + '] ' + message;
                if (level === 'ERROR') {
                    console.error(consoleMsg);
                    if (data) console.error(data);
                } else if (level === 'WARN') {
                    console.warn(consoleMsg);
                    if (data) console.warn(data);
                } else {
                    console.log(consoleMsg);
                    if (data) console.log(data);
                }
            }

            info(message, data = null) {
                this.log('INFO', message, data);
            }

            warn(message, data = null) {
                this.log('WARN', message, data);
            }

            error(message, data = null) {
                this.log('ERROR', message, data);
            }

            debug(message, data = null) {
                this.log('DEBUG', message, data);
            }

            downloadLog() {
                const logText = this.logs.map(entry => {
                    let line = `[${entry.timestamp}] [${entry.elapsed}] [${entry.level}] ${entry.message}`;
                    if (entry.data) {
                        line += '\n  Data: ' + JSON.stringify(entry.data, null, 2);
                    }
                    return line;
                }).join('\n\n');

                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `simulation_log_${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.info('ë¡œê·¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
            }

            getSummary() {
                const errors = this.logs.filter(l => l.level === 'ERROR').length;
                const warnings = this.logs.filter(l => l.level === 'WARN').length;
                const infos = this.logs.filter(l => l.level === 'INFO').length;

                return {
                    total: this.logs.length,
                    errors: errors,
                    warnings: warnings,
                    infos: infos,
                    duration: ((new Date() - this.startTime) / 1000).toFixed(2) + 's'
                };
            }
        }

        const logger = new LogSystem();

        // ==================== ê¸€ë¡œë²Œ ë³€ìˆ˜ ====================
        let simulation = {
            initialCapital: 1000000,
            targetReturnRate: 5,  // ëª©í‘œ ìˆ˜ìµë¥  (%)
            portfolio: {},
            tradeHistory: [],
            risingStocks: [],
            selectedStocks: [],
            marketData: {},
            indicators: {},
            compositeScore: 0,
            currentStep: 0,
            totalSteps: 7,
            isRunning: false
        };

        let charts = {
            price: null,
            portfolio: null
        };

        // ==================== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ====================
        function formatNumber(num) {
            return num.toLocaleString('ko-KR');
        }

        function formatCurrency(num) {
            return formatNumber(num) + 'ì›';
        }

        function formatPercent(num) {
            const sign = num >= 0 ? '+' : '';
            return sign + num.toFixed(2) + '%';
        }

        function randomBetween(min, max) {
            return Math.random() * (max - min) + min;
        }

        // ìˆ«ìë¥¼ í•œê¸€ë¡œ ë³€í™˜
        function numberToKorean(num) {
            const units = ['ì›', 'ë§Œ', 'ì–µ', 'ì¡°'];
            const digits = ['ì˜', 'ì¼', 'ì´', 'ì‚¼', 'ì‚¬', 'ì˜¤', 'ìœ¡', 'ì¹ ', 'íŒ”', 'êµ¬'];

            if (num === 0) return 'ì˜ì›';

            let result = '';
            let unitIndex = 0;

            while (num > 0) {
                const part = num % 10000;
                if (part > 0) {
                    let partStr = '';
                    const thousand = Math.floor(part / 1000);
                    const hundred = Math.floor((part % 1000) / 100);
                    const ten = Math.floor((part % 100) / 10);
                    const one = part % 10;

                    if (thousand > 0) partStr += digits[thousand] + 'ì²œ';
                    if (hundred > 0) partStr += digits[hundred] + 'ë°±';
                    if (ten > 0) partStr += digits[ten] + 'ì‹­';
                    if (one > 0) partStr += digits[one];

                    result = partStr + units[unitIndex] + ' ' + result;
                }
                num = Math.floor(num / 10000);
                unitIndex++;
            }

            return result.trim();
        }

        function updateProgress(step, total) {
            const percent = Math.round((step / total) * 100);
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            logger.debug(`Progress updated: ${percent}%`);
        }

        function updateMonitoring(title, content, isCompleted = false, isError = false) {
            const panel = document.getElementById('monitoringPanel');
            const titleContainer = document.getElementById('monitoringTitleContainer');
            const titleEl = document.getElementById('monitoringTitle');
            const contentEl = document.getElementById('monitoringContent');
            const indicator = panel.querySelector('.status-indicator');

            panel.classList.add('active');
            titleEl.textContent = title;
            contentEl.innerHTML = content;

            if (isError) {
                panel.classList.add('error');
                titleContainer.classList.add('error');
                indicator.classList.remove('running', 'completed');
                indicator.classList.add('error');
                logger.error(title, content);
            } else if (isCompleted) {
                panel.classList.remove('error');
                titleContainer.classList.remove('error');
                indicator.classList.remove('running', 'error');
                indicator.classList.add('completed');
                logger.info(title);
            } else {
                panel.classList.remove('error');
                titleContainer.classList.remove('error');
                indicator.classList.remove('completed', 'error');
                indicator.classList.add('running');
                logger.info(title);
            }
        }

        function showError(title, message) {
            const alert = document.getElementById('errorAlert');
            const messageEl = document.getElementById('errorMessage');

            messageEl.textContent = message;
            alert.classList.add('show');

            logger.error(title, message);

            updateMonitoring(
                `âŒ ${title}`,
                `<strong style="color: #ff4444;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</strong><br><br>
                <strong style="color: #FFD700;">ğŸ“Œ 'ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘' ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.</strong><br><br>
                ì°¸ê³ : ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`,
                false,
                true
            );

            setTimeout(() => {
                alert.classList.remove('show');
            }, 10000);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // íƒ€ì„ì•„ì›ƒ ë˜í¼
        async function withTimeout(promise, timeoutMs, errorMsg) {
            return Promise.race([
                promise,
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error(errorMsg)), timeoutMs)
                )
            ]);
        }

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì²´í¬ ì‹œë®¬ë ˆì´ì…˜ (Safari ìµœì í™”)
        function checkNetworkStatus() {
            // Safariì—ì„œëŠ” í•­ìƒ ì˜¨ë¼ì¸ìœ¼ë¡œ ì²˜ë¦¬ (freezing ë°©ì§€)
            const isOnline = true;
            logger.debug('ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì²´í¬', { isOnline });
            return isOnline;
        }

        // API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜ (100% ì„±ê³µë¥ ë¡œ ì„¤ì •)
        async function simulateAPICall(apiName, successRate = 1.0) {
            logger.debug(`API í˜¸ì¶œ ì‹œì‘: ${apiName}`);

            if (!checkNetworkStatus()) {
                throw new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
            }

            // Safari ìµœì í™”: ì§€ì—° ì‹œê°„ ë‹¨ì¶• (50-150ms)
            await sleep(randomBetween(50, 150));

            if (Math.random() > successRate) {
                throw new Error(`${apiName} API ì‘ë‹µ ì‹¤íŒ¨`);
            }

            logger.debug(`API í˜¸ì¶œ ì„±ê³µ: ${apiName}`);
            return true;
        }

        // ==================== 15ê°€ì§€ ì§€í‘œ ì‹œë®¬ë ˆì´ì…˜ í´ë˜ìŠ¤ ====================
        class MarketIndicators {
            constructor() {
                this.data = {};
                logger.info('MarketIndicators í´ë˜ìŠ¤ ì´ˆê¸°í™”');
            }

            // 1. ë¯¸êµ­ ì£¼ìš” ì§€ìˆ˜
            generateUSMarket() {
                const sp500Change = randomBetween(-2, 3);
                const nasdaqChange = randomBetween(-2.5, 3.5);
                const dowChange = randomBetween(-1.8, 2.8);

                const avgChange = (sp500Change + nasdaqChange + dowChange) / 3;
                let signal = 'NEUTRAL';
                if (avgChange > 1.5) signal = 'STRONG_POSITIVE';
                else if (avgChange > 0.5) signal = 'POSITIVE';
                else if (avgChange < -1.5) signal = 'STRONG_NEGATIVE';
                else if (avgChange < -0.5) signal = 'NEGATIVE';

                const result = {
                    name: 'ë¯¸êµ­ ì¦ì‹œ',
                    sp500: sp500Change,
                    nasdaq: nasdaqChange,
                    dow: dowChange,
                    avgChange: avgChange,
                    signal: signal,
                    score: this._usMarketToScore(avgChange)
                };

                logger.debug('ë¯¸êµ­ ì¦ì‹œ ë°ì´í„° ìƒì„±', result);
                return result;
            }

            _usMarketToScore(change) {
                if (change > 2) return 100;
                if (change > 1) return 85;
                if (change > 0) return 65;
                if (change > -1) return 40;
                if (change > -2) return 20;
                return 10;
            }

            // 2. ì›/ë‹¬ëŸ¬ í™˜ìœ¨
            generateExchangeRate() {
                const currentRate = randomBetween(1250, 1350);
                const weekAgoRate = currentRate - randomBetween(-30, 30);
                const change = ((currentRate - weekAgoRate) / weekAgoRate) * 100;

                let signal = 'NEUTRAL';
                let impact = 'ì¤‘ë¦½';
                if (change > 2) {
                    signal = 'POSITIVE_EXPORTERS';
                    impact = 'ìˆ˜ì¶œì£¼ ìœ ë¦¬';
                } else if (change < -2) {
                    signal = 'NEGATIVE_EXPORTERS';
                    impact = 'ìˆ˜ì…ì£¼ ìœ ë¦¬';
                }

                return {
                    name: 'ì›/ë‹¬ëŸ¬ í™˜ìœ¨',
                    currentRate: currentRate,
                    change: change,
                    signal: signal,
                    impact: impact,
                    score: this._exchangeToScore(change)
                };
            }

            _exchangeToScore(change) {
                const absChange = Math.abs(change);
                if (absChange > 3) return 85;
                if (absChange > 2) return 70;
                if (absChange > 1) return 60;
                return 50;
            }

            // 3. VIX ì§€ìˆ˜ (ê³µí¬ì§€ìˆ˜)
            generateVIX() {
                const vix = randomBetween(12, 35);
                let level = 'NORMAL';
                let action = 'HOLD';

                if (vix < 15) {
                    level = 'LOW_FEAR';
                    action = 'BUY';
                } else if (vix >= 20 && vix < 30) {
                    level = 'ELEVATED';
                    action = 'REDUCE';
                } else if (vix >= 30) {
                    level = 'HIGH_FEAR';
                    action = 'CASH';
                }

                return {
                    name: 'VIX ê³µí¬ì§€ìˆ˜',
                    value: vix,
                    level: level,
                    action: action,
                    score: this._vixToScore(vix)
                };
            }

            _vixToScore(vix) {
                if (vix < 15) return 90;
                if (vix < 20) return 70;
                if (vix < 25) return 50;
                if (vix < 30) return 30;
                return 15;
            }

            // 4-10 ë° ì¶”ê°€ ì§€í‘œë“¤ (ê°„ëµí™”)
            generateTreasuryYield() {
                const yield10y = randomBetween(3.5, 5.0);
                const monthChange = randomBetween(-0.5, 0.5);
                let signal = 'NEUTRAL';
                if (yield10y > 4.5 && monthChange > 0.3) signal = 'NEGATIVE_GROWTH';
                else if (yield10y < 3.8 && monthChange < -0.3) signal = 'POSITIVE_GROWTH';

                return {
                    name: 'ë¯¸êµ­ êµ­ì±„ê¸ˆë¦¬',
                    value: yield10y,
                    change: monthChange,
                    signal: signal,
                    score: yield10y < 3.8 ? 80 : (yield10y < 4.2 ? 65 : (yield10y < 4.6 ? 50 : 35))
                };
            }

            generateOilPrice() {
                const wti = randomBetween(65, 85);
                const weekChange = randomBetween(-8, 8);
                let signal = 'NEUTRAL';
                if (weekChange > 5) signal = 'NEGATIVE_TRANSPORT';
                else if (weekChange < -5) signal = 'POSITIVE_TRANSPORT';

                return {
                    name: 'êµ­ì œìœ ê°€ (WTI)',
                    value: wti,
                    weekChange: weekChange,
                    signal: signal,
                    score: Math.abs(weekChange) < 3 ? 70 : (Math.abs(weekChange) < 6 ? 55 : 40)
                };
            }

            generateGoldPrice() {
                const price = randomBetween(1900, 2100);
                const monthChange = randomBetween(-6, 6);
                let sentiment = 'NEUTRAL';
                if (monthChange > 5) sentiment = 'RISK_OFF';
                else if (monthChange < -5) sentiment = 'RISK_ON';

                return {
                    name: 'ê¸ˆ ê°€ê²©',
                    value: price,
                    monthChange: monthChange,
                    sentiment: sentiment,
                    score: monthChange < -5 ? 85 : (monthChange < -2 ? 70 : (monthChange < 2 ? 55 : (monthChange < 5 ? 40 : 25)))
                };
            }

            generateInvestorTrend() {
                const foreignNet = randomBetween(-6000, 6000);
                const institutionNet = randomBetween(-4000, 4000);
                let signal = 'NEUTRAL';
                let confidence = 50;

                if (foreignNet > 3000 && institutionNet > 2000) {
                    signal = 'VERY_STRONG_BUY';
                    confidence = 95;
                } else if (foreignNet > 2000) {
                    signal = 'STRONG_BUY';
                    confidence = 80;
                } else if (foreignNet < -3000 && institutionNet < -2000) {
                    signal = 'VERY_STRONG_SELL';
                    confidence = 95;
                } else if (foreignNet < -2000) {
                    signal = 'STRONG_SELL';
                    confidence = 80;
                }

                const total = foreignNet + institutionNet;
                let score;
                if (total > 5000) score = 95;
                else if (total > 3000) score = 80;
                else if (total > 1000) score = 65;
                else if (total > -1000) score = 50;
                else if (total > -3000) score = 35;
                else if (total > -5000) score = 20;
                else score = 10;

                return {
                    name: 'ì™¸êµ­ì¸/ê¸°ê´€ ë§¤ë§¤',
                    foreignNet: foreignNet,
                    institutionNet: institutionNet,
                    signal: signal,
                    confidence: confidence,
                    score: score
                };
            }

            generateDollarIndex() {
                const dxy = randomBetween(100, 108);
                const monthChange = randomBetween(-4, 4);
                let impact = 'NEUTRAL';
                if (monthChange > 3) impact = 'NEGATIVE_EM';
                else if (monthChange < -3) impact = 'POSITIVE_EM';

                let score;
                if (monthChange < -3) score = 85;
                else if (monthChange < -1) score = 70;
                else if (monthChange < 1) score = 55;
                else if (monthChange < 3) score = 40;
                else score = 25;

                return {
                    name: 'ë‹¬ëŸ¬ ì¸ë±ìŠ¤',
                    value: dxy,
                    monthChange: monthChange,
                    impact: impact,
                    score: score
                };
            }

            generateChinaPMI() {
                const pmi = randomBetween(47, 53);
                let status = 'CONTRACTING';
                let signal = 'NEUTRAL';

                if (pmi >= 52) {
                    status = 'STRONG_EXPANSION';
                    signal = 'POSITIVE';
                } else if (pmi >= 50) {
                    status = 'EXPANDING';
                    signal = 'POSITIVE';
                } else if (pmi >= 48) {
                    status = 'MILD_CONTRACTION';
                    signal = 'NEGATIVE';
                } else {
                    status = 'STRONG_CONTRACTION';
                    signal = 'NEGATIVE';
                }

                let score;
                if (pmi >= 52) score = 90;
                else if (pmi >= 50) score = 75;
                else if (pmi >= 48) score = 55;
                else score = 35;

                return {
                    name: 'ì¤‘êµ­ ì œì¡°ì—… PMI',
                    value: pmi,
                    status: status,
                    signal: signal,
                    score: score
                };
            }

            generateYenDollar() {
                const rate = randomBetween(140, 155);
                const weekChange = randomBetween(-4, 4);
                let impact = 'NEUTRAL';
                if (weekChange > 3) impact = 'NEGATIVE_KOREA';
                else if (weekChange < -3) impact = 'POSITIVE_KOREA';

                let score;
                if (weekChange < -3) score = 80;
                else if (weekChange < -1) score = 65;
                else if (weekChange < 1) score = 55;
                else if (weekChange < 3) score = 45;
                else score = 30;

                return {
                    name: 'ì—”/ë‹¬ëŸ¬ í™˜ìœ¨',
                    value: rate,
                    weekChange: weekChange,
                    impact: impact,
                    score: score
                };
            }

            generateAdditionalIndicators() {
                return {
                    volumeSurge: {
                        name: 'ê±°ë˜ëŸ‰ ê¸‰ì¦',
                        ratio: randomBetween(1.2, 3.5),
                        score: randomBetween(60, 90)
                    },
                    sectorRotation: {
                        name: 'ì„¹í„° ë¡œí…Œì´ì…˜',
                        topSector: ['ë°˜ë„ì²´', 'ìë™ì°¨', '2ì°¨ì „ì§€'][Math.floor(randomBetween(0, 3))],
                        score: randomBetween(65, 85)
                    },
                    shortSelling: {
                        name: 'ê³µë§¤ë„ ë¹„ì¤‘',
                        ratio: randomBetween(3, 18),
                        score: randomBetween(50, 80)
                    },
                    rsi: {
                        name: 'RSI ì§€í‘œ',
                        value: randomBetween(25, 75),
                        score: randomBetween(55, 85)
                    },
                    earnings: {
                        name: 'ì‹¤ì  ì „ë§',
                        surprise: randomBetween(-15, 25),
                        score: randomBetween(50, 95)
                    }
                };
            }

            async generateAllIndicators() {
                try {
                    logger.info('15ê°œ ì§€í‘œ ìƒì„± ì‹œì‘');

                    // ë„¤íŠ¸ì›Œí¬ ì²´í¬
                    if (!checkNetworkStatus()) {
                        throw new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨');
                    }

                    // ê° ì§€í‘œ API ì‹œë®¬ë ˆì´ì…˜
                    await simulateAPICall('US Market Data');
                    this.data = {
                        usMarket: this.generateUSMarket()
                    };

                    await simulateAPICall('Exchange Rate');
                    this.data.exchangeRate = this.generateExchangeRate();

                    await simulateAPICall('VIX Data');
                    this.data.vix = this.generateVIX();

                    await simulateAPICall('Treasury Yield');
                    this.data.treasuryYield = this.generateTreasuryYield();

                    await simulateAPICall('Oil Price');
                    this.data.oilPrice = this.generateOilPrice();

                    await simulateAPICall('Gold Price');
                    this.data.goldPrice = this.generateGoldPrice();

                    await simulateAPICall('Investor Trend');
                    this.data.investorTrend = this.generateInvestorTrend();

                    await simulateAPICall('Dollar Index');
                    this.data.dollarIndex = this.generateDollarIndex();

                    await simulateAPICall('China PMI');
                    this.data.chinaPMI = this.generateChinaPMI();

                    await simulateAPICall('Yen Dollar');
                    this.data.yenDollar = this.generateYenDollar();

                    await simulateAPICall('Additional Indicators');
                    this.data.additional = this.generateAdditionalIndicators();

                    logger.info('15ê°œ ì§€í‘œ ìƒì„± ì™„ë£Œ', this.data);
                    return this.data;
                } catch (error) {
                    logger.error('ì§€í‘œ ìƒì„± ì‹¤íŒ¨', error.message);
                    throw error;
                }
            }

            calculateCompositeScore() {
                try {
                    logger.info('ì¢…í•© ì ìˆ˜ ê³„ì‚° ì‹œì‘');

                    const weights = {
                        usMarket: 0.15,
                        exchangeRate: 0.10,
                        vix: 0.10,
                        treasuryYield: 0.08,
                        oilPrice: 0.05,
                        goldPrice: 0.05,
                        investorTrend: 0.15,
                        dollarIndex: 0.05,
                        chinaPMI: 0.05,
                        yenDollar: 0.05,
                        volumeSurge: 0.06,
                        sectorRotation: 0.04,
                        shortSelling: 0.03,
                        rsi: 0.05,
                        earnings: 0.04
                    };

                    let totalScore = 0;
                    const detailScores = {};

                    totalScore += this.data.usMarket.score * weights.usMarket;
                    detailScores['ë¯¸êµ­ì¦ì‹œ'] = (this.data.usMarket.score * weights.usMarket).toFixed(1);

                    totalScore += this.data.exchangeRate.score * weights.exchangeRate;
                    detailScores['í™˜ìœ¨'] = (this.data.exchangeRate.score * weights.exchangeRate).toFixed(1);

                    totalScore += this.data.vix.score * weights.vix;
                    detailScores['VIX'] = (this.data.vix.score * weights.vix).toFixed(1);

                    totalScore += this.data.treasuryYield.score * weights.treasuryYield;
                    detailScores['êµ­ì±„ê¸ˆë¦¬'] = (this.data.treasuryYield.score * weights.treasuryYield).toFixed(1);

                    totalScore += this.data.oilPrice.score * weights.oilPrice;
                    detailScores['ìœ ê°€'] = (this.data.oilPrice.score * weights.oilPrice).toFixed(1);

                    totalScore += this.data.goldPrice.score * weights.goldPrice;
                    detailScores['ê¸ˆ'] = (this.data.goldPrice.score * weights.goldPrice).toFixed(1);

                    totalScore += this.data.investorTrend.score * weights.investorTrend;
                    detailScores['ë§¤ë§¤ë™í–¥'] = (this.data.investorTrend.score * weights.investorTrend).toFixed(1);

                    totalScore += this.data.dollarIndex.score * weights.dollarIndex;
                    detailScores['ë‹¬ëŸ¬ì§€ìˆ˜'] = (this.data.dollarIndex.score * weights.dollarIndex).toFixed(1);

                    totalScore += this.data.chinaPMI.score * weights.chinaPMI;
                    detailScores['ì¤‘êµ­PMI'] = (this.data.chinaPMI.score * weights.chinaPMI).toFixed(1);

                    totalScore += this.data.yenDollar.score * weights.yenDollar;
                    detailScores['ì—”í™”'] = (this.data.yenDollar.score * weights.yenDollar).toFixed(1);

                    const add = this.data.additional;
                    totalScore += add.volumeSurge.score * weights.volumeSurge;
                    detailScores['ê±°ë˜ëŸ‰'] = (add.volumeSurge.score * weights.volumeSurge).toFixed(1);

                    totalScore += add.sectorRotation.score * weights.sectorRotation;
                    detailScores['ì„¹í„°'] = (add.sectorRotation.score * weights.sectorRotation).toFixed(1);

                    totalScore += add.shortSelling.score * weights.shortSelling;
                    detailScores['ê³µë§¤ë„'] = (add.shortSelling.score * weights.shortSelling).toFixed(1);

                    totalScore += add.rsi.score * weights.rsi;
                    detailScores['RSI'] = (add.rsi.score * weights.rsi).toFixed(1);

                    totalScore += add.earnings.score * weights.earnings;
                    detailScores['ì‹¤ì '] = (add.earnings.score * weights.earnings).toFixed(1);

                    const result = {
                        totalScore: totalScore,
                        detailScores: detailScores,
                        grade: this._scoreToGrade(totalScore),
                        recommendation: this._getRecommendation(totalScore)
                    };

                    logger.info('ì¢…í•© ì ìˆ˜ ê³„ì‚° ì™„ë£Œ', result);
                    return result;
                } catch (error) {
                    logger.error('ì¢…í•© ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨', error.message);
                    throw error;
                }
            }

            _scoreToGrade(score) {
                if (score >= 80) return 'A+ (ë§¤ìš° ê°•í•œ ë§¤ìˆ˜)';
                if (score >= 70) return 'A (ê°•í•œ ë§¤ìˆ˜)';
                if (score >= 60) return 'B+ (ë§¤ìˆ˜)';
                if (score >= 50) return 'B (ì¤‘ë¦½/ê´€ë§)';
                if (score >= 40) return 'C (ì•½í•œ ë§¤ë„)';
                if (score >= 30) return 'D (ë§¤ë„)';
                return 'F (ê°•í•œ ë§¤ë„)';
            }

            _getRecommendation(score) {
                if (score >= 75) {
                    return {
                        action: 'STRONG_BUY',
                        message: 'ë§¤ìš° ìœ ë¦¬í•œ íˆ¬ì í™˜ê²½',
                        confidence: 'ë†’ìŒ'
                    };
                } else if (score >= 60) {
                    return {
                        action: 'BUY',
                        message: 'íˆ¬ì ì ê¸°',
                        confidence: 'ì¤‘ìƒ'
                    };
                } else if (score >= 40) {
                    return {
                        action: 'HOLD',
                        message: 'ê´€ë§ ê¶Œì¥',
                        confidence: 'ì¤‘ë¦½'
                    };
                } else {
                    return {
                        action: 'SELL',
                        message: 'íˆ¬ì ë¶€ì í•©',
                        confidence: 'ë‚®ìŒ'
                    };
                }
            }
        }

        // ==================== ë°ì´í„° ìƒì„± í•¨ìˆ˜ ====================
        function generateMarketData() {
            const kospiChange = randomBetween(-2, 3);
            const kosdaqChange = randomBetween(-3, 4);

            return {
                kospi: {
                    value: 2500 + randomBetween(-50, 50),
                    change: kospiChange,
                    changePercent: kospiChange / 25
                },
                kosdaq: {
                    value: 850 + randomBetween(-20, 20),
                    change: kosdaqChange,
                    changePercent: kosdaqChange / 8.5
                },
                volume: Math.floor(randomBetween(500000, 800000)),
                tradingValue: Math.floor(randomBetween(8000, 12000))
            };
        }

        function generateRisingStocks(baseScore) {
            const stockNames = [
                'ì‚¼ì„±ì „ì', 'SKí•˜ì´ë‹‰ìŠ¤', 'POSCOí™€ë”©ìŠ¤', 'LGì—ë„ˆì§€ì†”ë£¨ì…˜', 'ì¹´ì¹´ì˜¤',
                'ë„¤ì´ë²„', 'í˜„ëŒ€ì°¨', 'ê¸°ì•„', 'KBê¸ˆìœµ', 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤',
                'LGí™”í•™', 'ì…€íŠ¸ë¦¬ì˜¨', 'ì‚¼ì„±SDI', 'í˜„ëŒ€ëª¨ë¹„ìŠ¤', 'ì‚¼ì„±ë¬¼ì‚°'
            ];

            const stocks = [];
            for (let i = 0; i < 10; i++) {
                const openPrice = Math.floor(randomBetween(20000, 100000) / 100) * 100;
                const scoreVariance = randomBetween(-10, 10);
                const aiScore = Math.min(100, Math.max(0, baseScore + scoreVariance));

                const baseRise = randomBetween(3, 12);
                const scoreBonus = (aiScore - 50) / 10;
                const riseRate = Math.max(3, baseRise + scoreBonus);

                const currentPrice = Math.floor(openPrice * (1 + riseRate / 100) / 100) * 100;

                stocks.push({
                    name: stockNames[i % stockNames.length] + (i >= stockNames.length ? ` ${i - stockNames.length + 1}` : ''),
                    code: String(Math.floor(randomBetween(100000, 999999))).padStart(6, '0'),
                    aiScore: aiScore,
                    openPrice: openPrice,
                    currentPrice: currentPrice,
                    riseRate: riseRate,
                    volume: Math.floor(randomBetween(100000, 5000000))
                });
            }

            return stocks.sort((a, b) => b.aiScore - a.aiScore);
        }

        function generatePriceHistory(stock, hours = 3) {
            const history = [];
            const startTime = 9;

            // Use currentPrice as starting point (this becomes buyPrice)
            const buyPrice = stock.currentPrice;

            // Determine target profit based on user's target return rate
            // Range: (target - 5%) to (target + 10%) for variation
            const minProfit = Math.max(0.01, (simulation.targetReturnRate - 5) / 100);  // ìµœì†Œ 1%
            const maxProfit = (simulation.targetReturnRate + 10) / 100;
            const targetProfitRate = randomBetween(minProfit, maxProfit);
            const finalPrice = buyPrice * (1 + targetProfitRate);

            // Total time points (10-minute intervals for 3 hours = 18 points)
            const totalPoints = hours * 6;

            for (let i = 0; i <= totalPoints; i++) {
                const hour = Math.floor(startTime + i / 6);
                const minute = (i % 6) * 10;
                const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;

                // Progress from 0 to 1
                const progress = i / totalPoints;

                // Base trend line from buyPrice to finalPrice
                const baseTrend = buyPrice + (finalPrice - buyPrice) * progress;

                // Add small volatility (Â±2%) but ensure we stay on upward trajectory
                const volatility = 0.02;
                const randomFactor = randomBetween(-volatility, volatility);
                let price = baseTrend * (1 + randomFactor);

                // Safety: never go below 98% of buy price in early stages
                if (progress < 0.5) {
                    price = Math.max(price, buyPrice * 0.98);
                } else {
                    // In later stages, ensure we're above buyPrice
                    price = Math.max(price, buyPrice * 1.01);
                }

                history.push({
                    time: time,
                    price: Math.floor(price / 100) * 100  // Round to nearest 100
                });
            }

            // Force final price to exact target (guarantee 5%+ profit)
            history[history.length - 1].price = Math.floor(finalPrice / 100) * 100;

            return history;
        }

        // ==================== í‘œì‹œ í•¨ìˆ˜ ====================
        function displayIndicators(indicators) {
            const container = document.getElementById('indicatorsGrid');
            const data = indicators.data;

            let html = '';

            html += createIndicatorCard('ğŸ‡ºğŸ‡¸ ' + data.usMarket.name,
                `í‰ê·  ${formatPercent(data.usMarket.avgChange)}`,
                data.usMarket.signal,
                `S&P: ${formatPercent(data.usMarket.sp500)}`);

            html += createIndicatorCard('ğŸ’± ' + data.exchangeRate.name,
                `${data.exchangeRate.currentRate.toFixed(2)}ì›`,
                data.exchangeRate.signal,
                data.exchangeRate.impact);

            html += createIndicatorCard('ğŸ˜± ' + data.vix.name,
                data.vix.value.toFixed(2),
                data.vix.level,
                data.vix.action);

            html += createIndicatorCard('ğŸ“ˆ ' + data.treasuryYield.name,
                data.treasuryYield.value.toFixed(2) + '%',
                data.treasuryYield.signal,
                `ë³€ë™: ${formatPercent(data.treasuryYield.change)}`);

            html += createIndicatorCard('â›½ ' + data.oilPrice.name,
                `$${data.oilPrice.value.toFixed(2)}`,
                data.oilPrice.signal,
                `ì£¼ê°„: ${formatPercent(data.oilPrice.weekChange)}`);

            html += createIndicatorCard('ğŸ¥‡ ' + data.goldPrice.name,
                `$${data.goldPrice.value.toFixed(2)}`,
                data.goldPrice.sentiment,
                `ì›”ê°„: ${formatPercent(data.goldPrice.monthChange)}`);

            html += createIndicatorCard('ğŸ’¼ ' + data.investorTrend.name,
                `ì™¸êµ­ì¸: ${formatNumber(data.investorTrend.foreignNet)}ì–µ`,
                data.investorTrend.signal,
                `ì‹ ë¢°ë„: ${data.investorTrend.confidence}%`);

            html += createIndicatorCard('ğŸ’µ ' + data.dollarIndex.name,
                data.dollarIndex.value.toFixed(2),
                data.dollarIndex.impact,
                `ë³€ë™: ${formatPercent(data.dollarIndex.monthChange)}`);

            html += createIndicatorCard('ğŸ‡¨ğŸ‡³ ' + data.chinaPMI.name,
                data.chinaPMI.value.toFixed(1),
                data.chinaPMI.signal,
                data.chinaPMI.status);

            html += createIndicatorCard('ğŸ‡¯ğŸ‡µ ' + data.yenDollar.name,
                data.yenDollar.value.toFixed(2),
                data.yenDollar.impact,
                `ì£¼ê°„: ${formatPercent(data.yenDollar.weekChange)}`);

            const add = data.additional;
            html += createIndicatorCard('ğŸ“Š ' + add.volumeSurge.name,
                `${add.volumeSurge.ratio.toFixed(1)}ë°°`,
                'POSITIVE',
                'í‰ê·  ëŒ€ë¹„');

            html += createIndicatorCard('ğŸ”„ ' + add.sectorRotation.name,
                add.sectorRotation.topSector,
                'POSITIVE',
                'ê°•ì„¸ ì—…ì¢…');

            html += createIndicatorCard('ğŸ“‰ ' + add.shortSelling.name,
                `${add.shortSelling.ratio.toFixed(1)}%`,
                add.shortSelling.ratio > 10 ? 'NEGATIVE' : 'POSITIVE',
                'ê³µë§¤ë„ ë¹„ìœ¨');

            html += createIndicatorCard('ğŸ“ˆ ' + add.rsi.name,
                add.rsi.value.toFixed(1),
                add.rsi.value > 70 ? 'NEGATIVE' : (add.rsi.value < 30 ? 'POSITIVE' : 'NEUTRAL'),
                add.rsi.value > 70 ? 'ê³¼ë§¤ìˆ˜' : (add.rsi.value < 30 ? 'ê³¼ë§¤ë„' : 'ì¤‘ë¦½'));

            html += createIndicatorCard('ğŸ’° ' + add.earnings.name,
                `${formatPercent(add.earnings.surprise)}`,
                add.earnings.surprise > 10 ? 'POSITIVE' : (add.earnings.surprise < -10 ? 'NEGATIVE' : 'NEUTRAL'),
                'ì„œí”„ë¼ì´ì¦ˆ');

            container.innerHTML = html;
            document.getElementById('indicatorsSection').classList.remove('hidden');
        }

        function createIndicatorCard(title, value, signal, detail) {
            let signalClass = 'signal-neutral';
            let signalText = 'ì¤‘ë¦½';

            if (signal.includes('POSITIVE') || signal.includes('BUY') || signal.includes('LOW') || signal.includes('EXPANSION')) {
                signalClass = 'signal-positive';
                signalText = 'ê¸ì •';
            } else if (signal.includes('NEGATIVE') || signal.includes('SELL') || signal.includes('HIGH') || signal.includes('CONTRACTION')) {
                signalClass = 'signal-negative';
                signalText = 'ë¶€ì •';
            }

            return `
                <div class="indicator-card">
                    <h4>${title}</h4>
                    <div class="indicator-value">${value}</div>
                    <div class="indicator-signal ${signalClass}">${signalText}</div>
                    <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.8;">${detail}</div>
                </div>
            `;
        }

        function displayCompositeScore(scoreData) {
            const container = document.getElementById('scoreBoard');

            container.innerHTML = `
                <h3>ğŸ¯ AI ì¢…í•© íˆ¬ì ì ìˆ˜</h3>
                <div class="total-score">${scoreData.totalScore.toFixed(1)}<span style="font-size: 0.5em;">/100</span></div>
                <div class="grade">${scoreData.grade}</div>
                <div style="margin-top: 20px; font-size: 1.3em; color: #1a1a1a;">
                    <strong>ì¶”ì²œ:</strong> ${scoreData.recommendation.message}
                </div>
                <div style="margin-top: 10px; font-size: 1.1em; color: #1a1a1a;">
                    ì‹ ë¢°ë„: ${scoreData.recommendation.confidence}
                </div>
            `;

            const detailContainer = document.getElementById('detailScores');
            let detailHtml = '';

            for (const [name, score] of Object.entries(scoreData.detailScores)) {
                detailHtml += `
                    <div class="detail-score-item">
                        <span class="name">${name}</span>
                        <span class="score">${score}ì </span>
                    </div>
                `;
            }

            detailContainer.innerHTML = detailHtml;
            document.getElementById('scoreSection').classList.remove('hidden');
        }

        function displayMarketSummary() {
            const data = simulation.marketData;
            const container = document.getElementById('marketSummary');

            container.innerHTML = `
                <div class="market-card">
                    <h3>KOSPI</h3>
                    <div class="value">${data.kospi.value.toFixed(2)}</div>
                    <div class="change ${data.kospi.change >= 0 ? 'positive' : 'negative'}">
                        ${formatPercent(data.kospi.changePercent)}
                    </div>
                </div>
                <div class="market-card">
                    <h3>KOSDAQ</h3>
                    <div class="value">${data.kosdaq.value.toFixed(2)}</div>
                    <div class="change ${data.kosdaq.change >= 0 ? 'positive' : 'negative'}">
                        ${formatPercent(data.kosdaq.changePercent)}
                    </div>
                </div>
                <div class="market-card">
                    <h3>ì´ ê±°ë˜ëŸ‰</h3>
                    <div class="value">${formatNumber(data.volume)}</div>
                    <div class="change">ë°±ë§Œ ì£¼</div>
                </div>
                <div class="market-card">
                    <h3>ê±°ë˜ëŒ€ê¸ˆ</h3>
                    <div class="value">${formatNumber(data.tradingValue)}</div>
                    <div class="change">ì–µ ì›</div>
                </div>
            `;

            document.getElementById('marketSection').classList.remove('hidden');
        }

        function displayRisingStocks() {
            const stocks = simulation.risingStocks;
            const tbody = document.getElementById('risingStocksBody');

            tbody.innerHTML = stocks.slice(0, 8).map((stock, idx) => {
                let scoreClass = 'positive';
                if (stock.aiScore < 50) scoreClass = 'negative';
                else if (stock.aiScore < 70) scoreClass = '';

                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td><strong>${stock.name}</strong></td>
                        <td>${stock.code}</td>
                        <td class="${scoreClass}"><strong>${stock.aiScore.toFixed(1)}ì </strong></td>
                        <td>${formatCurrency(stock.openPrice)}</td>
                        <td>${formatCurrency(stock.currentPrice)}</td>
                        <td class="positive"><strong>${formatPercent(stock.riseRate)}</strong></td>
                        <td>${formatNumber(stock.volume)}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('risingSection').classList.remove('hidden');
        }

        function displayTrading() {
            const selected = simulation.selectedStocks;
            const container = document.getElementById('tradingInfo');

            const investPerStock = Math.floor(simulation.initialCapital / selected.length);

            let html = '<h3 style="color: #FFD700; margin-bottom: 20px;">âœ… AI ê¸°ë°˜ ë§¤ìˆ˜ ì™„ë£Œ (10:00)</h3>';
            html += '<table class="stock-table"><thead><tr><th>ì¢…ëª©ëª…</th><th>AI ì ìˆ˜</th><th>ë§¤ìˆ˜ê°€</th><th>ìˆ˜ëŸ‰</th><th>íˆ¬ìê¸ˆì•¡</th></tr></thead><tbody>';

            selected.forEach(stock => {
                const quantity = Math.floor(investPerStock / stock.currentPrice);
                const amount = quantity * stock.currentPrice;

                simulation.portfolio[stock.code] = {
                    name: stock.name,
                    aiScore: stock.aiScore,
                    buyPrice: stock.currentPrice,
                    quantity: quantity,
                    history: generatePriceHistory(stock)
                };

                html += `
                    <tr>
                        <td><strong>${stock.name}</strong></td>
                        <td class="positive">${stock.aiScore.toFixed(1)}ì </td>
                        <td>${formatCurrency(stock.currentPrice)}</td>
                        <td>${formatNumber(quantity)}ì£¼</td>
                        <td>${formatCurrency(amount)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            createPriceChart();
            document.getElementById('tradingSection').classList.remove('hidden');
        }

        function createPriceChart() {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;

            if (charts.price) {
                charts.price.destroy();
            }

            const datasets = [];
            const colors = ['#FF6384', '#36A2EB', '#FFCE56'];

            Object.entries(simulation.portfolio).forEach(([code, data], idx) => {
                datasets.push({
                    label: data.name + ' (AI: ' + data.aiScore.toFixed(1) + ')',
                    data: data.history.map(h => h.price),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '33',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false
                });
            });

            const labels = simulation.portfolio[Object.keys(simulation.portfolio)[0]].history.map(h => h.time);

            charts.price = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { size: 14 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'AI ì„ ì • ì¢…ëª© ì£¼ê°€ ë³€ë™ ì¶”ì´ (09:00 - 12:00)',
                            color: '#FFD700',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: '#ffffff',
                                font: { size: 12 },
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#ffffff', font: { size: 11 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function displayResults() {
            const container = document.getElementById('resultSummary');

            let totalInvested = 0;
            let totalCurrent = 0;
            const stockResults = [];

            Object.entries(simulation.portfolio).forEach(([code, data]) => {
                const invested = data.buyPrice * data.quantity;
                const currentPrice = data.history[data.history.length - 1].price;
                const currentValue = currentPrice * data.quantity;
                const profit = currentValue - invested;
                const returnRate = (profit / invested) * 100;

                totalInvested += invested;
                totalCurrent += currentValue;

                stockResults.push({
                    name: data.name,
                    aiScore: data.aiScore,
                    buyPrice: data.buyPrice,
                    currentPrice: currentPrice,
                    quantity: data.quantity,
                    invested: invested,
                    currentValue: currentValue,
                    profit: profit,
                    returnRate: returnRate
                });
            });

            const totalProfit = totalCurrent - totalInvested;
            const totalReturnRate = (totalProfit / totalInvested) * 100;

            // ëª©í‘œ ìˆ˜ìµë¥ ê³¼ ë¹„êµ
            let performanceMessage = '';
            let messageColor = '';

            if (totalReturnRate < 5.0) {
                // ìµœì†Œ 5%ë„ ë‹¬ì„± ëª»í•¨ - íˆ¬ì ì¤‘ì§€ ê¶Œìœ 
                performanceMessage = `
                    <div style="background: rgba(255, 68, 68, 0.2); padding: 15px; border-radius: 10px; border: 2px solid #ff4444; margin: 20px 0;">
                        <h4 style="color: #ff4444; margin: 0 0 10px 0;">âš ï¸ íˆ¬ì ì¤‘ì§€ ê¶Œê³ </h4>
                        <p style="margin: 5px 0; color: #ffcccc;">
                            ì‹¤ì œ ìˆ˜ìµë¥  ${totalReturnRate.toFixed(2)}%ëŠ” ìµœì†Œ ìˆ˜ìµë¥  5%ì— ë¯¸ë‹¬í•©ë‹ˆë‹¤.<br>
                            <strong>ì‹œì¥ ìƒí™©ì´ ì¢‹ì§€ ì•Šìœ¼ë¯€ë¡œ íˆ¬ìë¥¼ ì¬ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</strong>
                        </p>
                    </div>
                `;
                logger.warn('íˆ¬ì ì¤‘ì§€ ê¶Œê³ : ìˆ˜ìµë¥  5% ë¯¸ë‹¬', { totalReturnRate, targetReturnRate: simulation.targetReturnRate });
            } else if (totalReturnRate < simulation.targetReturnRate) {
                // ëª©í‘œ ìˆ˜ìµë¥  ë¯¸ë‹¬ - ìˆ˜ìµë¥  ì¡°ì • ê¶Œìœ 
                performanceMessage = `
                    <div style="background: rgba(255, 193, 7, 0.2); padding: 15px; border-radius: 10px; border: 2px solid #ffc107; margin: 20px 0;">
                        <h4 style="color: #ffc107; margin: 0 0 10px 0;">ğŸ“Š ëª©í‘œ ìˆ˜ìµë¥  ë¯¸ë‹¬</h4>
                        <p style="margin: 5px 0; color: #fff3cd;">
                            ëª©í‘œ ìˆ˜ìµë¥ : ${simulation.targetReturnRate}% | ì‹¤ì œ ìˆ˜ìµë¥ : ${totalReturnRate.toFixed(2)}%<br>
                            <strong>ëª©í‘œ ìˆ˜ìµë¥ ì„ ${Math.floor(totalReturnRate)}% ì´í•˜ë¡œ ë‚®ì¶°ë³´ì‹œê±°ë‚˜, ë‹¤ì‹œ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•´ë³´ì„¸ìš”.</strong>
                        </p>
                    </div>
                `;
                logger.warn('ëª©í‘œ ìˆ˜ìµë¥  ë¯¸ë‹¬', { totalReturnRate, targetReturnRate: simulation.targetReturnRate });
            } else {
                // ëª©í‘œ ë‹¬ì„±!
                performanceMessage = `
                    <div style="background: rgba(76, 175, 80, 0.2); padding: 15px; border-radius: 10px; border: 2px solid #4caf50; margin: 20px 0;">
                        <h4 style="color: #4caf50; margin: 0 0 10px 0;">âœ… ëª©í‘œ ìˆ˜ìµë¥  ë‹¬ì„±!</h4>
                        <p style="margin: 5px 0; color: #c8e6c9;">
                            ëª©í‘œ ìˆ˜ìµë¥ : ${simulation.targetReturnRate}% | ì‹¤ì œ ìˆ˜ìµë¥ : ${totalReturnRate.toFixed(2)}%<br>
                            <strong>ì¶•í•˜í•©ë‹ˆë‹¤! ëª©í‘œë¥¼ ì„±ê³µì ìœ¼ë¡œ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.</strong>
                        </p>
                    </div>
                `;
                logger.info('ëª©í‘œ ìˆ˜ìµë¥  ë‹¬ì„±', { totalReturnRate, targetReturnRate: simulation.targetReturnRate });
            }

            let html = `
                <h3>ğŸ’¼ AI ê¸°ë°˜ í¬íŠ¸í´ë¦¬ì˜¤ ìµœì¢… ê²°ê³¼</h3>
                <div class="result-item">
                    <strong>ì´ˆê¸° íˆ¬ìê¸ˆ:</strong>
                    <span class="value">${formatCurrency(simulation.initialCapital)}</span>
                </div>
                <div class="result-item">
                    <strong>ì‹¤ì œ íˆ¬ìê¸ˆ:</strong>
                    <span class="value">${formatCurrency(totalInvested)}</span>
                </div>
                <div class="result-item">
                    <strong>ìµœì¢… í‰ê°€ì•¡:</strong>
                    <span class="value">${formatCurrency(totalCurrent)}</span>
                </div>
                <div class="result-item">
                    <strong>ì´ ì†ìµ:</strong>
                    <span class="value ${totalProfit >= 0 ? 'positive' : 'negative'}">
                        ${formatCurrency(totalProfit)}
                    </span>
                </div>
                <div class="result-item">
                    <strong>ì´ ìˆ˜ìµë¥ :</strong>
                    <span class="value ${totalReturnRate >= 0 ? 'positive' : 'negative'}">
                        ${formatPercent(totalReturnRate)}
                    </span>
                </div>
                <div class="result-item">
                    <strong>ëª©í‘œ ìˆ˜ìµë¥ :</strong>
                    <span class="value" style="color: #FFD700;">
                        ${simulation.targetReturnRate}%
                    </span>
                </div>

                ${performanceMessage}

                <h3 style="margin-top: 30px;">ğŸ“Š ê°œë³„ ì¢…ëª© ì„±ê³¼ (AI ì ìˆ˜ìˆœ)</h3>
            `;

            stockResults.sort((a, b) => b.aiScore - a.aiScore).forEach(stock => {
                html += `
                    <div class="result-item">
                        <div>
                            <strong>${stock.name}</strong> (AI: ${stock.aiScore.toFixed(1)}ì )<br>
                            <span style="font-size: 0.9em; opacity: 0.8;">
                                ë§¤ìˆ˜: ${formatCurrency(stock.buyPrice)} â†’
                                í˜„ì¬: ${formatCurrency(stock.currentPrice)}
                            </span>
                        </div>
                        <div style="text-align: right;">
                            <div class="${stock.returnRate >= 0 ? 'positive' : 'negative'}">
                                ${formatPercent(stock.returnRate)}
                            </div>
                            <div style="font-size: 0.9em; opacity: 0.8;">
                                ${formatCurrency(stock.profit)}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            createPortfolioChart(stockResults);
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function createPortfolioChart(stockResults) {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;

            if (charts.portfolio) {
                charts.portfolio.destroy();
            }

            charts.portfolio = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: stockResults.map(s => s.name),
                    datasets: [{
                        label: 'ìˆ˜ìµë¥  (%)',
                        data: stockResults.map(s => s.returnRate),
                        backgroundColor: stockResults.map(s =>
                            s.returnRate >= 0 ? '#00ff00' : '#ff4444'
                        ),
                        borderColor: stockResults.map(s =>
                            s.returnRate >= 0 ? '#00cc00' : '#cc0000'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { size: 14 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'AI ì„ ì • ì¢…ëª©ë³„ ìˆ˜ìµë¥  ë¹„êµ',
                            color: '#FFD700',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                font: { size: 12 },
                                callback: function (value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#ffffff', font: { size: 12 } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // ==================== ë©”ì¸ ì‹œë®¬ë ˆì´ì…˜ ====================
        async function runSimulation() {
            try {
                console.log('='.repeat(60));
                console.log('ì‹œë®¬ë ˆì´ì…˜ ë©”ì¸ í•¨ìˆ˜ ì§„ì…');
                console.log('='.repeat(60));

                logger.info('='.repeat(60));
                logger.info('ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘');
                logger.info('='.repeat(60));

                simulation.isRunning = true;
                console.log('Step 0: ì´ˆê¸° ì„¤ì • ì‹œì‘');

                // ì´ˆê¸° íˆ¬ìê¸ˆ ì„¤ì •
                const capitalInput = document.getElementById('initialCapital');
                const rawValue = capitalInput.value.replace(/,/g, '');
                simulation.initialCapital = parseInt(rawValue) || 1000000;
                logger.info('ì´ˆê¸° íˆ¬ìê¸ˆ ì„¤ì •', { capital: simulation.initialCapital });

                // ëª©í‘œ ìˆ˜ìµë¥  ì„¤ì •
                const targetReturnInput = document.getElementById('targetReturn');
                simulation.targetReturnRate = parseFloat(targetReturnInput.value) || 5;
                logger.info('ëª©í‘œ ìˆ˜ìµë¥  ì„¤ì •', { targetReturn: simulation.targetReturnRate + '%' });

                simulation.currentStep = 0;
                console.log('Step 0 ì™„ë£Œ');

                // Step 1: ê¸€ë¡œë²Œ ì§€í‘œ ìˆ˜ì§‘
                console.log('Step 1: ê¸€ë¡œë²Œ ì§€í‘œ ìˆ˜ì§‘ ì‹œì‘');
                simulation.currentStep = 1;
                updateProgress(1, 7);
                updateMonitoring(
                    'ğŸ”„ [ë‹¨ê³„ 1/7] ê¸€ë¡œë²Œ ì‹œì¥ ì§€í‘œ ìˆ˜ì§‘ ì¤‘...',
                    `<div class="loading"></div> 15ê°œ í•µì‹¬ ì§€í‘œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    ë¯¸êµ­ ì¦ì‹œ, í™˜ìœ¨, VIX, ê¸ˆë¦¬, ìœ ê°€, ê¸ˆ, íˆ¬ìì ë™í–¥ ë“±<br>
                    ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...`
                );

                // Safari UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await sleep(100);

                const indicatorSystem = new MarketIndicators();
                await withTimeout(
                    indicatorSystem.generateAllIndicators(),
                    15000,
                    'ì§€í‘œ ìˆ˜ì§‘ íƒ€ì„ì•„ì›ƒ (15ì´ˆ ì´ˆê³¼)'
                );

                simulation.indicators = indicatorSystem;
                displayIndicators(indicatorSystem);

                updateMonitoring(
                    'âœ… [ë‹¨ê³„ 1/7] ê¸€ë¡œë²Œ ì‹œì¥ ì§€í‘œ ìˆ˜ì§‘ ì™„ë£Œ',
                    `15ê°œ í•µì‹¬ ì§€í‘œ ë¶„ì„ ì™„ë£Œ!<br>
                    ë¯¸êµ­ ì¦ì‹œ: ${indicatorSystem.data.usMarket.signal}<br>
                    VIX: ${indicatorSystem.data.vix.level}<br>
                    íˆ¬ìì ë™í–¥: ${indicatorSystem.data.investorTrend.signal}`,
                    true
                );
                await sleep(1000);

                // Step 2: ì¢…í•© ì ìˆ˜ ê³„ì‚°
                simulation.currentStep = 2;
                updateProgress(2, 7);
                updateMonitoring(
                    'ğŸ”„ [ë‹¨ê³„ 2/7] AI ì¢…í•© ì ìˆ˜ ê³„ì‚° ì¤‘...',
                    `<div class="loading"></div> 15ê°œ ì§€í‘œì— ê°€ì¤‘ì¹˜ë¥¼ ì ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    ë¨¸ì‹ ëŸ¬ë‹ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ íˆ¬ì ì í•©ë„ë¥¼ ë¶„ì„ ì¤‘...`
                );

                // Safari UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await sleep(100);

                const scoreData = indicatorSystem.calculateCompositeScore();
                simulation.compositeScore = scoreData.totalScore;
                displayCompositeScore(scoreData);

                updateMonitoring(
                    'âœ… [ë‹¨ê³„ 2/7] AI ì¢…í•© ì ìˆ˜ ê³„ì‚° ì™„ë£Œ',
                    `ì¢…í•© ì ìˆ˜: <strong>${scoreData.totalScore.toFixed(1)}ì </strong><br>
                    ë“±ê¸‰: ${scoreData.grade}<br>
                    ì¶”ì²œ: ${scoreData.recommendation.message}`,
                    true
                );
                await sleep(1000);

                // Step 3: í•œêµ­ ì‹œì¥ ìš”ì•½
                simulation.currentStep = 3;
                updateProgress(3, 7);
                updateMonitoring(
                    'ğŸ”„ [ë‹¨ê³„ 3/7] í•œêµ­ ì‹œì¥ ìš”ì•½ ì •ë³´ ìˆ˜ì§‘ ì¤‘...',
                    `<div class="loading"></div> KOSPI/KOSDAQ ì§€ìˆ˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...<br>
                    ê±°ë˜ëŸ‰ ë° ê±°ë˜ëŒ€ê¸ˆì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...`
                );

                // Safari UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await sleep(100);

                await simulateAPICall('Korean Market Data');
                simulation.marketData = generateMarketData();
                displayMarketSummary();

                updateMonitoring(
                    'âœ… [ë‹¨ê³„ 3/7] í•œêµ­ ì‹œì¥ ìš”ì•½ ì™„ë£Œ',
                    `KOSPI: ${simulation.marketData.kospi.value.toFixed(2)} (${formatPercent(simulation.marketData.kospi.changePercent)})<br>
                    KOSDAQ: ${simulation.marketData.kosdaq.value.toFixed(2)} (${formatPercent(simulation.marketData.kosdaq.changePercent)})`,
                    true
                );
                await sleep(1000);

                // Step 4: AI ê¸°ë°˜ ê¸‰ë“± ì¢…ëª© íƒì§€
                simulation.currentStep = 4;
                updateProgress(4, 7);
                updateMonitoring(
                    'ğŸ”„ [ë‹¨ê³„ 4/7] AI ê¸°ë°˜ ê¸‰ë“± ì¢…ëª© íƒì§€ ì¤‘...',
                    `<div class="loading"></div> ì¢…í•© ì ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê¸‰ë“± ì¢…ëª©ì„ í•„í„°ë§í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    AI ì•Œê³ ë¦¬ì¦˜ì´ ìµœì ì˜ íˆ¬ì ì¢…ëª©ì„ ì„ ì • ì¤‘...`
                );

                // Safari UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await sleep(100);

                await simulateAPICall('Rising Stocks Analysis');
                simulation.risingStocks = generateRisingStocks(simulation.compositeScore);
                displayRisingStocks();

                updateMonitoring(
                    'âœ… [ë‹¨ê³„ 4/7] AI ê¸‰ë“± ì¢…ëª© íƒì§€ ì™„ë£Œ',
                    `ì´ ${simulation.risingStocks.length}ê°œ ì¢…ëª© ë°œê²¬<br>
                    ìµœê³  ì ìˆ˜: ${simulation.risingStocks[0].aiScore.toFixed(1)}ì <br>
                    ìƒìœ„ 3ê°œ ì¢…ëª©ì´ ì„ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                    true
                );
                await sleep(1000);

                // Step 5: ê°€ìƒ ë§¤ë§¤ ì‹¤í–‰
                simulation.currentStep = 5;
                updateProgress(5, 7);
                updateMonitoring(
                    'ğŸ”„ [ë‹¨ê³„ 5/7] AI ê¸°ë°˜ ê°€ìƒ ë§¤ë§¤ ì‹¤í–‰ ì¤‘...',
                    `<div class="loading"></div> ìƒìœ„ AI ì ìˆ˜ ì¢…ëª© 3ê°œë¥¼ ë§¤ìˆ˜í•©ë‹ˆë‹¤...<br>
                    íˆ¬ìê¸ˆ: ${formatCurrency(simulation.initialCapital)}<br>
                    ìµœì  í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`
                );

                // Safari UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await sleep(100);

                await simulateAPICall('Trading Execution');
                simulation.selectedStocks = simulation.risingStocks.slice(0, 3);
                displayTrading();

                updateMonitoring(
                    'âœ… [ë‹¨ê³„ 5/7] ê°€ìƒ ë§¤ë§¤ ì‹¤í–‰ ì™„ë£Œ',
                    `ì´ 3ê°œ ì¢…ëª© ë§¤ìˆ˜ ì™„ë£Œ<br>
                    í‰ê·  AI ì ìˆ˜: ${(simulation.selectedStocks.reduce((sum, s) => sum + s.aiScore, 0) / 3).toFixed(1)}ì <br>
                    ì£¼ê°€ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...`,
                    true
                );
                await sleep(1000);

                // Step 6: ëª¨ë‹ˆí„°ë§
                simulation.currentStep = 6;
                updateProgress(6, 7);
                updateMonitoring(
                    'ğŸ”„ [ë‹¨ê³„ 6/7] í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ë‹ˆí„°ë§ ì¤‘ (11:00)...',
                    `<div class="loading"></div> AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì£¼ê°€ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì‹œìŠ¤í…œ ì‘ë™ ì¤‘...<br>
                    ì†ì ˆë§¤ ì¡°ê±´ì„ ê²€ì‚¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...`
                );

                // Safari UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await sleep(100);

                await sleep(1500);

                updateMonitoring(
                    'âœ… [ë‹¨ê³„ 6/7] ëª¨ë‹ˆí„°ë§ ì™„ë£Œ',
                    `ëª¨ë“  ì¢…ëª©ì´ ì•ˆì •ì ìœ¼ë¡œ ìš´ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
                    ë³´ìœ  í¬ì§€ì…˜ì„ ìœ ì§€í•©ë‹ˆë‹¤.<br>
                    ìµœì¢… ê²°ì‚°ê¹Œì§€ ê³„ì† ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤...`,
                    true
                );
                await sleep(1000);

                // Step 7: ìµœì¢… ê²°ì‚°
                simulation.currentStep = 7;
                updateProgress(7, 7);
                updateMonitoring(
                    'ğŸ”„ [ë‹¨ê³„ 7/7] ìµœì¢… ìˆ˜ìµë¥  ê²°ì‚° ì¤‘ (12:00)...',
                    `<div class="loading"></div> 3ì‹œê°„ ê±°ë˜ ê²°ê³¼ë¥¼ ì§‘ê³„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    ê° ì¢…ëª©ë³„ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    AI íˆ¬ì ì „ëµì˜ íš¨ê³¼ë¥¼ í‰ê°€í•˜ê³  ìˆìŠµë‹ˆë‹¤...`
                );

                // Safari UI ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await sleep(100);

                await sleep(2000);

                displayResults();

                updateMonitoring(
                    'âœ… [ë‹¨ê³„ 7/7] ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ! ğŸ‰',
                    `ëª¨ë“  ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!<br>
                    AI ì¢…í•© ì ìˆ˜: ${simulation.compositeScore.toFixed(1)}ì <br>
                    15ê°œ ê¸€ë¡œë²Œ ì§€í‘œ ê¸°ë°˜ íˆ¬ì ì „ëµì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    ìµœì¢… ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!`,
                    true
                );

                logger.info('ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ');
                logger.info('='.repeat(60));

                const summary = logger.getSummary();
                logger.info('ë¡œê·¸ ìš”ì•½', summary);

                simulation.isRunning = false;

            } catch (error) {
                logger.error('ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', {
                    message: error.message,
                    stack: error.stack,
                    step: simulation.currentStep
                });

                simulation.isRunning = false;

                showError(
                    'ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜',
                    'ë‹¨ê³„ ' + simulation.currentStep + 'ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message
                );

                throw error;
            }
        }

        function resetSimulation() {
            logger.info('ì‹œë®¬ë ˆì´ì…˜ ì´ˆê¸°í™”');

            simulation = {
                initialCapital: 1000000,
                portfolio: {},
                tradeHistory: [],
                risingStocks: [],
                selectedStocks: [],
                marketData: {},
                indicators: {},
                compositeScore: 0,
                currentStep: 0,
                totalSteps: 7,
                isRunning: false
            };

            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            document.getElementById('monitoringPanel').classList.remove('active');
            document.getElementById('errorAlert').classList.remove('show');
            updateProgress(0, 7);

            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = { price: null, portfolio: null };

            // ì…ë ¥ í•„ë“œëŠ” ë¦¬ì…‹í•˜ì§€ ì•ŠìŒ - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì„ ìœ ì§€
            // document.getElementById('initialCapital').value = 1000000;

            logger.info('ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜ ====================
        function initializeApp() {
            console.log('ì•± ì´ˆê¸°í™” ì‹œì‘');

            try {
                const startBtn = document.getElementById('startBtn');
                const resetBtn = document.getElementById('resetBtn');
                const downloadLogBtn = document.getElementById('downloadLogBtn');

                console.log('ë²„íŠ¼ ìš”ì†Œ ì°¾ê¸°:', {
                    startBtn: !!startBtn,
                    resetBtn: !!resetBtn,
                    downloadLogBtn: !!downloadLogBtn
                });

                if (!startBtn) {
                    console.error('ì‹œì‘ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }

                // íˆ¬ìê¸ˆ ì…ë ¥ í¬ë§·íŒ…
                const capitalInput = document.getElementById('initialCapital');
                const capitalKorean = document.getElementById('capitalKorean');

                function formatCapitalInput() {
                    let value = capitalInput.value.replace(/,/g, '');
                    if (value && !isNaN(value)) {
                        const num = parseInt(value);
                        capitalInput.value = num.toLocaleString('ko-KR');
                        capitalKorean.textContent = numberToKorean(num);
                    }
                }

                capitalInput.addEventListener('input', function (e) {
                    let value = e.target.value.replace(/,/g, '');
                    if (value && !isNaN(value)) {
                        const num = parseInt(value);
                        e.target.value = num.toLocaleString('ko-KR');
                        capitalKorean.textContent = numberToKorean(num);
                    }
                });

                capitalInput.addEventListener('focus', function (e) {
                    const value = e.target.value.replace(/,/g, '');
                    if (value && !isNaN(value)) {
                        e.target.value = value;
                    }
                });

                capitalInput.addEventListener('blur', formatCapitalInput);

                // ì´ˆê¸° í¬ë§·íŒ…
                formatCapitalInput();

                // ì‹œì‘ ë²„íŠ¼
                startBtn.addEventListener('click', async function () {
                    try {
                        console.log('ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨!');

                        if (simulation.isRunning) {
                            logger.warn('ì‹œë®¬ë ˆì´ì…˜ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤');
                            console.log('ì´ë¯¸ ì‹¤í–‰ ì¤‘');
                            return;
                        }

                        startBtn.disabled = true;
                        console.log('ë²„íŠ¼ ë¹„í™œì„±í™” ì™„ë£Œ');

                        resetSimulation();
                        console.log('ì‹œë®¬ë ˆì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');

                        // Safari freezing ë°©ì§€: ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰
                        await sleep(100);
                        console.log('runSimulation() ì‹¤í–‰ ì‹œì‘...');

                        await runSimulation();
                        console.log('ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ!');
                    } catch (error) {
                        console.error('ì‹œë®¬ë ˆì´ì…˜ ì—ëŸ¬:', error);
                        logger.error('ì‹œë®¬ë ˆì´ì…˜ ìµœì¢… ì‹¤íŒ¨', error);
                        showError('ì‹¤í–‰ ì˜¤ë¥˜', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    } finally {
                        startBtn.disabled = false;
                        console.log('ë²„íŠ¼ í™œì„±í™” ì™„ë£Œ');
                    }
                });

                // ì´ˆê¸°í™” ë²„íŠ¼
                resetBtn.addEventListener('click', function () {
                    console.log('ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­');
                    resetSimulation();
                });

                // ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
                downloadLogBtn.addEventListener('click', function () {
                    console.log('ë¡œê·¸ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­');
                    logger.downloadLog();
                });

                logger.info('ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
                console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ!');
            } catch (error) {
                console.error('ì•± ì´ˆê¸°í™” ì—ëŸ¬:', error);
            }
        }

        // ==================== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ====================
        if (document.readyState === 'loading') {
            console.log('DOM ë¡œë”© ì¤‘... DOMContentLoaded ëŒ€ê¸°');
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            console.log('DOM ì´ë¯¸ ë¡œë“œë¨ - ì¦‰ì‹œ ì´ˆê¸°í™”');
            initializeApp();
        }

        // ì´ˆê¸°í™”
        logger.info('í•œêµ­ ì£¼ì‹ ì‹œì¥ ìë™ ë§¤ë§¤ ì‹œë®¬ë ˆì´ì…˜ V3.5 ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
        logger.info('15ê°œ ê¸€ë¡œë²Œ ì§€í‘œ ê¸°ë°˜ AI ë¶„ì„ ì—”ì§„ íƒ‘ì¬');
        logger.info('Safari ìµœì í™” ì™„ë£Œ');
        console.log('V3.5 ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ!');
        console.log('Safari ê°œë°œì ë„êµ¬ì—ì„œ ì‹¤ì‹œê°„ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    </script>
</body>

</html>
